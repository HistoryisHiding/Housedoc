<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>HouseDoc ‚Äì Walkthrough Journal</title>

<!-- iOS & PWA meta -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HouseDoc">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="theme-color" content="#0b0c0f">

<style>
  :root { --pad: 14px; --radius: 14px; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; }
  body { margin: 0; background: #0b0c0f; color: #f2f4f8; }
  header { position: sticky; top: 0; z-index: 10; backdrop-filter: saturate(180%) blur(12px); background: rgba(12,14,18,0.7); padding: var(--pad); border-bottom: 1px solid #1f232b;}
  h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
  main { padding: var(--pad); max-width: 900px; margin: 0 auto; }
  .card { background: #11141a; border: 1px solid #1f232b; border-radius: var(--radius); padding: var(--pad); margin-bottom: 16px; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  label { font-size: 14px; opacity: 0.9; }
  input[type="text"], textarea { width: 100%; padding: 12px; background: #0c0f14; color: #f2f4f8; border: 1px solid #2a2f39; border-radius: 12px; }
  textarea { min-height: 88px; }
  button, .btn { appearance: none; border: 1px solid #2a2f39; background: #171b22; color: #e8ecf4; padding: 12px 14px; border-radius: 12px; font-weight: 600; }
  button.primary { background: #246bfc; border-color: #246bfc; color: white; }
  button:disabled { opacity: 0.6; }
  small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; opacity: 0.85; }
  .obs { border-left: 3px solid #2a6bf6; padding-left: 10px; }
  .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #2a2f39; background:#0c0f14; }
  .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: 8px; margin-top: 8px; }
  .media-grid > div { background:#0c0f14; border:1px solid #2a2f39; border-radius:10px; padding:8px; text-align:center; }
  .footer { text-align:center; opacity:0.7; font-size:12px; padding: 20px 0 40px; }
  .install { display:none; margin-left:auto; }
</style>
</head>
<body>
<header class="row" style="justify-content:space-between;">
  <h1>HouseDoc ‚Äì Walkthrough Journal</h1>
  <button id="installBtn" class="install primary">Install</button>
</header>
<main>
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="flex:1 1 auto; min-width: 200px;">
        <label for="project">Project name</label>
        <input id="project" type="text" placeholder="e.g., 12 Maple St ‚Äì 1st Walkthrough">
      </div>
      <div>
        <label>&nbsp;</label><br>
        <button id="newObs" class="primary">+ New Observation</button>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <span class="pill"><span id="locStatus">Location: off</span></span>
      <span class="pill"><span id="audioStatus">Narration: idle</span></span>
      <span class="pill"><span id="obsCount">0 observations</span></span>
    </div>
  </section>

  <section id="obsList"></section>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <button id="exportHTML" class="primary">Export Report (.html)</button>
      <button id="clearAll">Clear All</button>
    </div>
    <p style="margin-top:10px; opacity:0.8;">Tip: After exporting, share the file to Files or Mail. You can reopen the report later and all photos, audio, and videos remain embedded.</p>
  </section>

  <div class="footer">Made for on-site documentation. Works offline. No data leaves your device.</div>
</main>

<template id="obsTpl">
  <div class="card obs">
    <div class="row" style="justify-content:space-between; align-items: baseline;">
      <div>
        <div class="row" style="gap:8px; align-items: baseline;">
          <strong class="title"></strong>
          <small class="mono time"></small>
          <small class="mono gps"></small>
        </div>
      </div>
      <div class="row">
        <button class="del">Delete</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <input class="subtitle" type="text" placeholder="Short label (e.g., Parlor ‚Äì north wall)">
    </div>

    <div class="row" style="margin-top:8px;">
      <textarea class="notes" placeholder="Notes (materials, condition, markings, measurements, context)"></textarea>
    </div>

    <div class="row" style="margin-top:8px;">
      <div>
        <label class="btn">
          üì∑ Add Photos
          <input class="photos" type="file" accept="image/*" capture="environment" multiple style="display:none">
        </label>
      </div>
      <div>
        <label class="btn">
          üé• Add Video
          <input class="video" type="file" accept="video/*" capture="environment" style="display:none">
        </label>
      </div>
      <div>
        <button class="record">üéôÔ∏è Record Narration</button>
        <button class="stopRec" disabled>Stop</button>
      </div>
    </div>

    <div class="media-grid gallery"></div>
  </div>
</template>

<script>
// Register service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(console.warn);
  });
}

// Handle PWA install prompt (Android/desktop). iOS uses "Add to Home Screen".
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});
installBtn?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

const $ = sel => document.querySelector(sel);
const obsList = $('#obsList');
const obsTpl = $('#obsTpl');

let observations = []; // persisted to localStorage

function saveState() {
  localStorage.setItem('housedoc_state', JSON.stringify({
    project: $('#project').value || '',
    observations
  }));
  $('#obsCount').textContent = `${observations.length} observation${observations.length===1?'':'s'}`;
}

async function restoreState() {
  const raw = localStorage.getItem('housedoc_state');
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    $('#project').value = parsed.project || '';
    observations = parsed.observations || [];
    observations.forEach(renderObservation);
    $('#obsCount').textContent = `${observations.length} observation${observations.length===1?'':'s'}`;
  } catch(e) { console.warn(e); }
}

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleString();
}

function humanGPS(lat, lon, acc) {
  if (lat == null) return '‚Ä¢ GPS: n/a';
  const accTxt = acc ? ` ¬±${Math.round(acc)}m` : '';
  return `‚Ä¢ GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}${accTxt}`;
}

function renderObservation(o) {
  const node = obsTpl.content.firstElementChild.cloneNode(true);
  node.dataset.id = o.id;

  node.querySelector('.title').textContent = o.title;
  node.querySelector('.time').textContent = `‚Ä¢ ${formatTime(o.time)}`;
  node.querySelector('.gps').textContent = humanGPS(o.lat, o.lon, o.acc);

  const subtitle = node.querySelector('.subtitle');
  subtitle.value = o.subtitle || '';
  subtitle.addEventListener('input', e => { o.subtitle = e.target.value; saveState(); });

  const notes = node.querySelector('.notes');
  notes.value = o.notes || '';
  notes.addEventListener('input', e => { o.notes = e.target.value; saveState(); });

  const photosInput = node.querySelector('.photos');
  photosInput.addEventListener('change', async e => {
    const files = Array.from(e.target.files || []);
    for (const f of files) {
      const dataURL = await fileToDataURL(f);
      o.photos.push({ name: f.name, dataURL });
    }
    drawGallery(node.querySelector('.gallery'), o);
    saveState();
    photosInput.value = '';
  });

  const videoInput = node.querySelector('.video');
  videoInput.addEventListener('change', async e => {
    const f = e.target.files?.[0];
    if (f) {
      o.video = { name: f.name, dataURL: await fileToDataURL(f) };
      drawGallery(node.querySelector('.gallery'), o);
      saveState();
    }
    videoInput.value = '';
  });

  const recBtn = node.querySelector('.record');
  const stopBtn = node.querySelector('.stopRec');
  recBtn.addEventListener('click', () => startRecordingFor(o, recBtn, stopBtn));
  stopBtn.addEventListener('click', () => stopRecordingFor(o, recBtn, stopBtn));

  node.querySelector('.del').addEventListener('click', () => {
    if (!confirm('Delete this observation?')) return;
    observations = observations.filter(x => x.id !== o.id);
    node.remove(); saveState();
  });

  drawGallery(node.querySelector('.gallery'), o);
  obsList.prepend(node);
}

function drawGallery(container, o) {
  container.innerHTML = '';
  (o.photos || []).forEach((p,i) => {
    const d = document.createElement('div');
    d.innerHTML = `<div style="font-size:12px; opacity:0.8; margin-bottom:6px;">Photo ${i+1}</div>
                   <img src="${p.dataURL}" alt="photo" style="max-width:100%; height:120px; object-fit:cover; border-radius:8px;" />`;
    container.appendChild(d);
  });
  if (o.video) {
    const d = document.createElement('div');
    d.innerHTML = `<div style="font-size:12px; opacity:0.8; margin-bottom:6px;">Video</div>
                   <video controls src="${o.video.dataURL}" style="width:100%; max-height:140px; border-radius:8px;"></video>`;
    container.appendChild(d);
  }
  if (o.audio) {
    const d = document.createElement('div');
    d.innerHTML = `<div style="font-size:12px; opacity:0.8; margin-bottom:6px;">Narration</div>
                   <audio controls src="${o.audio.dataURL}" style="width:100%;"></audio>`;
    container.appendChild(d);
  }
}

async function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

document.getElementById('newObs').addEventListener('click', async () => {
  const idx = observations.length + 1;
  const now = Date.now();
  const title = `Observation ${idx}`;
  const o = { id: crypto.randomUUID(), title, time: now, lat: null, lon: null, acc: null,
              subtitle: '', notes: '', photos: [], video: null, audio: null };
  try {
    const pos = await getPositionOnce();
    o.lat = pos.coords.latitude; o.lon = pos.coords.longitude; o.acc = pos.coords.accuracy;
    document.getElementById('locStatus').textContent = 'Location: on';
  } catch (e) {}
  observations.push(o);
  renderObservation(o);
  saveState();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

document.getElementById('exportHTML').addEventListener('click', () => {
  const report = buildReportHTML();
  const blob = new Blob([report], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const safeName = (document.querySelector('#project').value || 'HouseDoc_Report').replace(/[^\w\-]+/g, '_');
  a.download = safeName + '.html'; a.href = url; document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
});

document.getElementById('clearAll').addEventListener('click', () => {
  if (!confirm('Clear all observations? This cannot be undone.')) return;
  observations = []; document.getElementById('obsList').innerHTML = ''; saveState();
});

function buildReportHTML() {
  const proj = (document.querySelector('#project').value || '').replace(/</g,'&lt;');
  const rows = observations.map((o, idx) => {
    const time = formatTime(o.time);
    const gps = humanGPS(o.lat, o.lon, o.acc);
    const photos = (o.photos||[]).map((p,i)=>`<div><div>Photo ${i+1}</div><img src="${p.dataURL}" style="max-width:100%;height:160px;object-fit:cover;border-radius:8px;border:1px solid #ddd"></div>`).join('');
    const vid = o.video ? `<div><div>Video</div><video controls src="${o.video.dataURL}" style="width:100%;max-height:200px;border-radius:8px;border:1px solid #ddd"></video></div>` : '';
    const aud = o.audio ? `<div><div>Narration</div><audio controls src="${o.audio.dataURL}" style="width:100%"></audio></div>` : '';
    const subtitle = (o.subtitle||'').replace(/</g,'&lt;');
    const notes = (o.notes||'').replace(/</g,'&lt;').replace(/\n/g,'<br>');
    const mapLink = (o.lat!=null && o.lon!=null) ? `<a href="https://maps.apple.com/?ll=${o.lat},${o.lon}" target="_blank" rel="noopener">Open in Apple Maps</a>` : '';
    return `
      <section style="border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0;">
        <h3 style="margin:0 0 6px 0;">${idx+1}. ${o.title}${subtitle? " ‚Äî "+subtitle : ""}</h3>
        <div style="opacity:0.7;font-size:12px; margin-bottom:6px;">${time} ‚Ä¢ ${gps} ${mapLink? " ‚Ä¢ "+mapLink : ""}</div>
        <p style="white-space:pre-wrap;">${notes||''}</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;">
          ${photos} ${vid} ${aud}
        </div>
      </section>
    `;
  }).join('');

  const html = `<!doctype html><html><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>${proj ? proj + " ‚Äî " : ""}HouseDoc Report</title></head>
    <body style="font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif; background:#fff; color:#111; margin:0;">
      <div style="padding:16px 14px; position:sticky; top:0; background:#fff; border-bottom:1px solid #eee;">
        <h1 style="font-size:20px; margin:0;">${proj || 'HouseDoc Report'}</h1>
        <div style="opacity:0.6;font-size:12px">Generated ${formatTime(Date.now())}</div>
      </div>
      <main style="padding:14px; max-width:900px; margin:0 auto;">
        ${rows || '<p>No observations yet.</p>'}
      </main>
    </body></html>`;
  return html;
}

// Audio recording (narration)
async function startRecordingFor(o, btn, stopBtn) {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const recorder = new MediaRecorder(stream);
    let chunks = [];
    recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const dataURL = await blobToDataURL(blob);
      o.audio = { name: `narration-${o.id}.webm`, dataURL };
      const card = [...document.querySelectorAll('.obs')].find(n => n.dataset.id === o.id);
      if (card) drawGallery(card.querySelector('.gallery'), o);
      document.getElementById('audioStatus').textContent = 'Narration: saved';
      saveState();
      stream.getTracks().forEach(t => t.stop());
    };
    recorder.start();
    btn.disabled = true; stopBtn.disabled = false;
    stopBtn._stop = () => { if (recorder.state !== 'inactive') recorder.stop(); btn.disabled = false; stopBtn.disabled = true; };
    document.getElementById('audioStatus').textContent = 'Narration: recording‚Ä¶';
  } catch (e) {
    alert('Microphone access was blocked. Enable it in Settings > Safari > Microphone.');
  }
}
function stopRecordingFor(o, btn, stopBtn) { stopBtn._stop?.(); }

function blobToDataURL(blob) {
  return new Promise(res => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.readAsDataURL(blob);
  });
}

// Location
function getPositionOnce() {
  return new Promise((res, rej) => {
    if (!navigator.geolocation) return rej(new Error('No geolocation'));
    navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, maximumAge: 5000, timeout: 5000 });
  });
}

window.addEventListener('pageshow', restoreState);
</script>
</body>
</html>
